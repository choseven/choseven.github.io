<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>GXC Game</title>
    <style>
      @-webkit-keyframes rotation {
        from {
          -webkit-transform: rotate(0deg);
        }

        to {
          -webkit-transform: rotate(360deg);
        }
      }

      @-moz-keyframes rotation {
        from {
          -moz-transform: rotate(0deg);
        }

        to {
          -moz-transform: rotate(360deg);
        }
      }

      @-o-keyframes rotation {
        from {
          -o-transform: rotate(0deg);
        }

        to {
          -o-transform: rotate(360deg);
        }
      }

      @keyframes rotation {
        from {
          transform: rotate(0deg);
        }

        to {
          transform: rotate(360deg);
        }
      }

      body {
        font-family: arial;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        min-width: 100vw;
        background: radial-gradient(
          56.63% 56.63% at 50% 43.37%,
          #1c1726 0%,
          #060612 100%
        );
      }

      .emscripten {
        padding-right: 0;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }

      div.emscripten {
        text-align: center;
      }

      canvas.emscripten {
        display: none;
        border: 0px none;
        background-color: black;
        position: relative;
        transition: opacity 5s ease-in;
        -webkit-transition: opacity 5s ease-in;
        opacity: 0;
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: -o-crisp-edges;
        image-rendering: pixelated;
        -ms-interpolation-mode: nearest-neighbor;
      }

      canvas.active {
        animation-name: fadeIn;
        animation-duration: 2s;
        opacity: 1;
      }
      
      @keyframes fadeIn {
        0% {
          opacity: 0;
        }

        100% {
          opacity: 1;
        }
      }

      .spinner {
        height: 30px;
        width: 30px;

        -webkit-animation: rotation 0.8s linear infinite;
        -moz-animation: rotation 0.8s linear infinite;
        -o-animation: rotation 0.8s linear infinite;
        animation: rotation 0.8s linear infinite;

        border: 5px solid #bdff00;
        border-top: 5px solid #719900;
        border-radius: 100%;
      }

      #status {
        display: inline-block;
        vertical-align: top;
        font-weight: bold;
        color: white;
      }

      #progress {
        width: 250px;
        height: 10px;
        -webkit-appearance: none;
        appearance: none;
        padding: 5px;
      }

      progress[value]::-webkit-progress-bar {
        background-color: #8492a6;
        height: 10px;
        border-radius: 15px;
      }
      
      progress[value]::-webkit-progress-value {
        background-image: -webkit-linear-gradient(left, #719900, #bdff00);
        height: 10px;
        border-radius: 15px;
      }

      div.loading {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        pointer-events: none;
      }
      
      div.loading > * {
        padding: 10px;
        margin: 10px;
      }
    </style>
  </head>

  <body>
    <canvas
      class="emscripten"
      id="canvas"
      oncontextmenu="event.preventDefault()"
      tabindex="-1"
    >
    </canvas>
    
    <div class="loading">
      <div class="spinner" id="spinner"></div>
      <div class="emscripten" id="status">Downloading...</div>

      <progress value="0" max="100" id="progress" hidden="1"></progress>
    </div>

    <script>
      // IMPORTANT: Change the number 5 to match however many .00X files you have
      function mergeFiles(fileParts) {
          return new Promise((resolve, reject) => {
              let buffers = [];
  
              function fetchPart(index) {
                  if (index >= fileParts.length) {
                      let mergedBlob = new Blob(buffers);
                      let mergedFileUrl = URL.createObjectURL(mergedBlob);
                      resolve(mergedFileUrl);
                      return;
                  }
                  fetch(fileParts[index]).then((response) => response.arrayBuffer()).then((data) => {
                      buffers.push(data);
                      fetchPart(index + 1);
                  }).catch(reject);
              }
              fetchPart(0);
          });
      }
  
      function getParts(file, start, end) {
          let parts = [];
          for (let i = start; i <= end; i++) {
              // Format number with leading zeros (001, 002, 003, etc.)
              let paddedNum = String(i).padStart(3, '0');
              parts.push(file + "." + paddedNum);
          }
          return parts;
      }
  
      mergeFiles(getParts("game.unx", 1, 5)).then(async url => {
          window.gameUnxUrl = url;
  
          const originalFetch = window.fetch;
          window.fetch = async function (...args) {
              let [url, options] = args;
              if (typeof url === 'string' && url.includes("game.unx")) {
                  console.log("fetch:", url);
                  url = window.gameUnxUrl;
              } else if (url instanceof Request && url.url.includes("game.unx")) {
                  console.log("fetch request:", url.url);
                  url = new Request(window.gameUnxUrl, url);
              }
              return originalFetch.call(this, url, options);
          };
  
          const originalOpen = XMLHttpRequest.prototype.open;
          XMLHttpRequest.prototype.open = function (method, url, ...rest) {
              if (url.includes("game.unx")) {
                  console.log("XHR:", url);
                  url = window.gameUnxUrl;
              }
              return originalOpen.call(this, method, url, ...rest);
          };
          
          let index = document.createElement("script");
          index.src = "index.js";
          document.body.appendChild(index);
  
          let runner = document.createElement("script");
          runner.src = "runner.js";
          document.body.appendChild(runner);
      }).catch(error => {
          console.error("Failed to merge files:", error);
      });
    </script>
  </body>
</html>