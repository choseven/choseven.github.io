<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Great Time Trio</title>
    <link rel="icon" type="image/png" href="icon-128.png" />
    
    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
        }
        html, body {
            background: #000;
            color: #fff;
            overflow: hidden;
            touch-action: none;
            -ms-touch-action: none;
            width: 100%;
            height: 100%;
        }
        canvas {
            touch-action: none;
            -ms-touch-action: none;
            display: block;
        }
        #c2canvasdiv {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #loadingMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #fff;
            z-index: 1000;
        }
    </style>
</head>
 
<body>
    <div id="loadingMessage">Loading Great Time Trio...</div>
    
    <!-- The canvas must be inside a div called c2canvasdiv -->
    <div id="c2canvasdiv">
        <!-- The canvas the project will render to -->
        <canvas id="c2canvas" width="848" height="480"></canvas>
    </div>
   
    <!-- Hidden file inputs for web file dialogs -->
    <input style="display:none;" id="c2nwOpenFileDialog" type="file" />
    <input style="display:none;" id="c2nwChooseFolderDialog" type="file" webkitdirectory />
    <input style="display:none;" id="c2nwSaveDialog" type="file" />
   
    <!-- Construct 2 exported games require jQuery -->
    <script src="jquery-3.4.1.min.js"></script>
    
    <script>
        // ========================================
        // CRITICAL: NW.js to Browser Compatibility Polyfill
        // This MUST load before c2runtime.js
        // ========================================
        (function() {
            'use strict';
            
            console.log('Initializing NW.js browser compatibility layer...');
            
            // Path module polyfill
            var pathPolyfill = {
                dirname: function(p) {
                    if (!p || typeof p !== 'string') return '.';
                    var idx = Math.max(p.lastIndexOf('/'), p.lastIndexOf('\\'));
                    return idx === -1 ? '.' : p.substring(0, idx);
                },
                basename: function(p) {
                    if (!p || typeof p !== 'string') return '';
                    var idx = Math.max(p.lastIndexOf('/'), p.lastIndexOf('\\'));
                    return p.substring(idx + 1);
                },
                join: function() {
                    var parts = Array.prototype.slice.call(arguments);
                    return parts.join('/').replace(/\/+/g, '/');
                },
                resolve: function() {
                    return Array.prototype.slice.call(arguments).join('/');
                },
                extname: function(p) {
                    if (!p || typeof p !== 'string') return '';
                    var idx = p.lastIndexOf('.');
                    return idx === -1 ? '' : p.substring(idx);
                }
            };
            
            // FS module polyfill
            var fsPolyfill = {
                readFileSync: function() { return ''; },
                writeFileSync: function() {},
                existsSync: function() { return false; },
                mkdirSync: function() {},
                readdirSync: function() { return []; }
            };
            
            // OS module polyfill
            var osPolyfill = {
                platform: function() { return 'browser'; },
                type: function() { return 'Browser'; },
                homedir: function() { return '/'; }
            };
            
            // Child process polyfill
            var childProcessPolyfill = {
                exec: function() {},
                spawn: function() { return { on: function() {} }; }
            };
            
            // CRITICAL: Process polyfill - Must exist before c2runtime.js loads
            if (typeof window.process === 'undefined' || window.process === null) {
                window.process = {
                    platform: 'browser',
                    versions: {
                        node: false,
                        'node-webkit': false,
                        nw: false,
                        chromium: false
                    },
                    env: {},
                    execPath: '',
                    mainModule: {
                        filename: ''
                    }
                };
            } else {
                // Ensure versions exists even if process is defined
                if (!window.process.versions || typeof window.process.versions !== 'object') {
                    window.process.versions = {
                        node: false,
                        'node-webkit': false,
                        nw: false,
                        chromium: false
                    };
                }
            }
            
            // Override require() globally
            if (typeof window.require === 'undefined') {
                window.require = function(module) {
                    console.warn('require() polyfill handling module:', module);
                    
                    switch(module) {
                        case 'path': return pathPolyfill;
                        case 'fs': return fsPolyfill;
                        case 'os': return osPolyfill;
                        case 'child_process': return childProcessPolyfill;
                        case 'nw.gui': 
                            return {
                                Window: {
                                    get: function() {
                                        return {
                                            show: function() {},
                                            showDevTools: function() {},
                                            on: function() {}
                                        };
                                    }
                                },
                                Clipboard: {
                                    get: function() {
                                        return {
                                            set: function() {},
                                            get: function() { return ''; }
                                        };
                                    }
                                }
                            };
                        default: 
                            return {};
                    }
                };
            }
            
            // NW.js object polyfill
            if (typeof window.nw === 'undefined') {
                window.nw = {
                    require: window.require,
                    App: { 
                        quit: function() { console.log('nw.App.quit() called in browser (ignored)'); } 
                    },
                    Window: { 
                        get: function() { 
                            return {
                                show: function() {},
                                showDevTools: function() {},
                                on: function() {}
                            }; 
                        } 
                    },
                    Shell: {},
                    Clipboard: { 
                        get: function() { 
                            return { 
                                set: function() {}, 
                                get: function() { return ''; } 
                            }; 
                        } 
                    }
                };
            }
            
            // Set NW.js detection flags to false
            window.isNodeWebkit = false;
            window.c2nodewebkit = false;
            window.c2isNodeWebkit = false;
            
            // Create stub nwgui
            window.nwgui = null;
            
            console.log('NW.js browser compatibility layer initialized successfully');
            console.log('process.versions:', window.process.versions);
            
        })();
        // ========================================
        // End of Polyfill
        // ========================================
    </script>
   
    <!-- The runtime script - loads AFTER polyfills -->
    <script src="c2runtime.js"></script>
    
    <script>
        // Start the Construct 2 project running on window load
        jQuery(document).ready(function () {
            // Hide loading message
            setTimeout(function() {
                document.getElementById('loadingMessage').style.display = 'none';
            }, 1000);
            
            // Create new runtime using the c2canvas
            cr_createRuntime("c2canvas");
        });
       
        // Pause and resume on page becoming visible/invisible
        function onVisibilityChanged() {
            if (document.hidden || document.mozHidden || document.webkitHidden || document.msHidden)
                cr_setSuspended(true);
            else
                cr_setSuspended(false);
        }
       
        document.addEventListener("visibilitychange", onVisibilityChanged, false);
        document.addEventListener("mozvisibilitychange", onVisibilityChanged, false);
        document.addEventListener("webkitvisibilitychange", onVisibilityChanged, false);
        document.addEventListener("msvisibilitychange", onVisibilityChanged, false);
        
        // Handle canvas scaling for different screen sizes
        window.addEventListener('resize', function() {
            if (typeof cr_sizeCanvas !== 'undefined') {
                cr_sizeCanvas(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>